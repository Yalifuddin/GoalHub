{% extends 'base.html' %} {% block meta %}
<title>Register - GoalHub</title>
{% endblock meta %} {% block content %}
<div class="form-style">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">
        <div class="text-center mb-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
          <p class="text-gray-500">Create your GoalHub account</p>
        </div>

        <!-- Form Errors Display -->
        {% if form.non_field_errors %}
        <div class="mb-6">
          {% for error in form.non_field_errors %}
          <div
            class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700"
          >
            {{ error }}
          </div>
          {% endfor %}
        </div>
        {% endif %} {% if form.errors %}
        <div class="mb-6">
          {% for field, errors in form.errors.items %} {% if field != '__all__'%} {% for error in errors %}
          <div
            class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2"
          >
            <strong>{{ field|title }}:</strong> {{ error }}
          </div>
          {% endfor %} {% endif %} {% endfor %}
        </div>
        {% endif %}

        <form method="POST" action="" class="space-y-5" id="registerForm">
          {% csrf_token %}

          <div>
            <label
              for="username"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Username</label
            >
            <input
              id="username"
              name="username"
              type="text"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-600 transition duration-200"
              placeholder="Choose a username"
            />
          </div>

          <div>
            <label
              for="password1"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Password</label
            >
            <input
              id="password1"
              name="password1"
              type="password"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-600 transition duration-200"
              placeholder="Create a password"
            />
          </div>

          <div>
            <label
              for="password2"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Confirm Password</label
            >
            <input
              id="password2"
              name="password2"
              type="password"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-600 transition duration-200"
              placeholder="Confirm your password"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-blue-800 text-white font-medium py-3 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 transition duration-200"
          >
            Create Account
          </button>
        </form>

        <!-- Messages Display -->
        {% if messages %}
        <div class="mt-6">
          {% for message in messages %}
          <div
            class="px-4 py-3 rounded text-sm border {% if message.tags == 'success' %} bg-blue-50 border-blue-200 text-blue-700 {% elif message.tags == 'error' %} bg-red-50 border-red-200 text-red-700 {% else %} bg-gray-50 border-gray-200 text-gray-700 {% endif %}"
          >
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="mt-6 text-center">
          <p class="text-gray-500 text-sm">
            Already have an account?
            <a
              href="{% url 'main:login' %}"
              class="text-blue-700 hover:text-blue-800 font-medium"
            >
              Sign In
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    const match = document.cookie.match(
      "(^|;)\\s*" + name + "\\s*=\\s*([^;]+)"
    );
    return match ? decodeURIComponent(match[2]) : null;
  }

  const registerForm = document.getElementById("registerForm");
  const registerBtn =
    registerForm && registerForm.querySelector('button[type="submit"]');

  if (registerForm) {
    registerForm.addEventListener("submit", function (e) {
      e.preventDefault();
      submitRegister();
    });
  }

  async function submitRegister() {
    const form = document.getElementById("registerForm");
    const btn = registerBtn;
    if (btn) btn.disabled = true;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch("{% url 'main:register' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken":
            getCookie("csrftoken") ||
            (document.querySelector("[name=csrfmiddlewaretoken]") || {}).value,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      if (response.status === 403) {
        showToast(
          "CSRF token invalid atau cookie tidak dikirim. Cek konfigurasi cookie.",
          "",
          "error"
        );
        return;
      }

      const result = await response.json();
      console.log("register result", result);

      if (response.ok && result.success) {
        try {
          showToast(
            "Registration successful!",
            "Welcome to GoalHub!",
            "success"
          );
        } catch (e) {
          console.error("showToast error", e);
        }
        // fallback redirect even if showToast fails
        if (result.redirect) {
          setTimeout(() => {
            window.location.href = result.redirect;
          }, 900);
        } else {
          setTimeout(() => {
            window.location.href = "{% url 'main:login' %}";
          }, 900);
        }
      } else {
        const errMsg = result.errors
          ? Object.values(result.errors).flat().join(" ")
          : result.message || "Registration failed.";
        try {
          showToast("Registration failed.", errMsg, "error");
        } catch (e) {
          console.error("showToast error", e);
        }
      }
    } catch (error) {
      console.error("Error registering:", error);
      showToast("An error occurred during registration.", "", "error");
    } finally {
      if (btn) btn.disabled = false;
    }
  }
</script>

{% endblock content %}
